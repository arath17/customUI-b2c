<html>
  <head>
    <title>User details</title>

    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
  </head>

  <body>
    <div id="api" role="main"></div>
    <button id="goBackButton" onclick="window.location.reload();" hidden>
      Go Back
    </button>
    <script>
      function query (selector) {
        return document.querySelector(selector)
      }
      function queryAll (selector) {
        return document.querySelectorAll(selector)
      }
      function show (element) {
        element.hidden = false
      }
      function hide (element) {
        element.hidden = true
      }
      function hideUsingStyle (element) {
        element.style.display = 'none'
      }
      function insertExpiryTimeLabel () {
        var expiryTimeLabel = document.createElement('div')
        expiryTimeLabel.id = 'expiryTimeLabel'
        expiryTimeLabel.innerHTML = 'Code expires in 5 mins'
        hide(expiryTimeLabel)
        query('#VerificationCode').insertAdjacentElement(
          'afterend',
          expiryTimeLabel
        )
      }
      function insertPasswordCheckDiv () {
        var passwordcheck = document.createElement('div')
        passwordcheck.id = 'passwordcheck'
        passwordcheck.innerHTML =
          '<div id="uppercase"><span id="tickUppercase">X</span> Uppercase</div><div id="lowercase"><span id="tickLowercase">X</span> Lowercase</div><div id="digit"><span id="tickDigit">X</span> digit</div>'
        query('#attributeList').insertAdjacentElement('afterend', passwordcheck)
        var newPassword = query('#newPassword')
        newPassword.oninput = function () {
          var val = this.value
          if (val.search(/[A-Z]/g) == -1) {
            query('#tickUppercase').innerHTML = 'X'
          } else {
            query('#tickUppercase').innerHTML = '\\//'
          }
          if (val.search(/[a-z]/g) == -1) {
            query('#tickLowercase').innerHTML = 'X'
          } else {
            query('#tickLowercase').innerHTML = '\\//'
          }
          if (val.search(/[0-9]/g) == -1) {
            query('#tickDigit').innerHTML = 'X'
          } else {
            query('#tickDigit').innerHTML = '\\//'
          }
        }
      }
      function makePwdToggler (pwd) {
        var checkbox = document.createElement('img')
        checkbox.setAttribute('src', 'https://localhost:8080/eye_slash.png')
        var id = pwd.id + 'toggler'
        checkbox.setAttribute('id', id)

        pwd.insertAdjacentElement('afterend', checkbox)

        function toggle () {
          if (pwd.type === 'password') {
            pwd.type = 'text';
            checkbox.src = 'https://localhost:8080/eye.png';
          } else {
            pwd.type = 'password';
            checkbox.src = 'https://localhost:8080/eye_slash.png';
          }
        }
        checkbox.onclick = toggle;
      }
      function setupPwdTogglers () {
        var pwdInputs = document.querySelectorAll('input[type=password]')
        for (var i = 0; i < pwdInputs.length; i++) {
          makePwdToggler(pwdInputs[i])
        }
      }

      var pages = {
        EMAIL: {
          identifier: function () {
            return (
              query('#emailVerificationControl_but_send_code').style.display !==
              'none'
            )
          },
          applyChanges: function () {
            show(query('#email'))
            hide(query('#continue'))
            hide(query('#expiryTimeLabel'))
            hide(query('#goBackButton'))
          }
        },
        CODE: {
          identifier: function () {
            return (
              query('#emailVerificationControl_but_verify_code').style
                .display !== 'none'
            )
          },
          applyChanges: function () {
            hide(query('#email'))
            query(
              '#emailVerificationControl_success_message'
            ).innerHTML = `Verification code has been sent to <b>${
              query('#email').value
            }</b>`
            hide(query('#continue'))
            show(query('#expiryTimeLabel'))
            show(query('#goBackButton'))
          }
        },
        CONTINUE: {
          identifier: function () {
            return (
              query('#emailVerificationControl_but_change_claims').style
                .display !== 'none'
            )
          },
          applyChanges: function () {
            hideUsingStyle(query('#emailVerificationControl_but_change_claims'))
            hideUsingStyle(query('#emailVerificationControl_success_message'))
            hide(query('#email'))
            show(query('#goBackButton'))
            hide(query('#continue'))
            query('#continue').click()
          }
        }
      };

      function finalPage () {
        return query('#newPassword') !== null
      }

      function applyFinalPageChanges () {
        setupPwdTogglers()
        insertPasswordCheckDiv()
        show(query('#continue'))
        show(query('#goBackButton'))
      }
      var pageNames = Object.keys(pages)
      function getCurrentPage () {
        for (var i = 0; i < pageNames.length; i++) {
          var pageName = pageNames[i]
          var pageIdentifier = pages[pageName].identifier
          if (pageIdentifier()) {
            return pageName
          }
        }
      }

      function applyChanges (pageName) {
        pages[pageName].applyChanges()
      }
      var state = {}
      if (finalPage()) {
        applyFinalPageChanges()
      } else {
        insertExpiryTimeLabel()

        var MutationObserver = new MutationObserver(function () {
          var currentPage = getCurrentPage()
          if (state.page !== currentPage) {
            state.page = currentPage
            if (currentPage) {
              applyChanges(currentPage)
            }
          }
        })

        queryAll('.buttons').forEach(button => {
          MutationObserver.observe(button, {
            childList: true,
            attributes: true,
            characterData: false,
            subtree: true,
            attributeFilter: ['style']
          })
        })
      }
    </script>
  </body>
</html>
